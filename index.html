<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mr Presentation | مستر بريزنتيشن — قوالب + توليد PPT من نص/ملفات</title>

  <meta name="description" content="مستر بريزنتيشن — صمّم عرضك من نص أو PDF/DOCX مباشرةً. قوالب جاهزة ومواضيع متعددة للسوق الخليجي." />
  <meta name="keywords" content="Mr Presentation, مستر بريزنتيشن, قوالب بوربوينت, تحويل PDF إلى بوربوينت, DOCX إلى PPT, السعودية, الخليج, Company profile" />
  <meta property="og:title" content="Mr Presentation - توليد العروض من نص/ملفات" />
  <meta property="og:description" content="ارفع ملف PDF أو Word أو اكتب نصك—ونولّد لك عرض احترافي جاهز." />
  <meta property="og:image" content="logo.png" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <!-- المكتبات المحلية -->
  <script src="libs/pptxgen.bundle.js"></script>
  <script src="libs/mammoth.browser.min.js"></script>
  <script src="libs/pdf.min.js"></script>
  <script>
    // PDF.js worker
    window.pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'libs/pdf.worker.min.js';
  </script>

  <style>
    html, body {width:100%; overflow-x:hidden; scroll-behavior:smooth;}
    body{
      font-family:'Cairo',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
      color:#e5e7eb;
      background:#0b1220 url('tech-bg.gif') center/cover fixed no-repeat;
    }
    :root{--vio:#7c3aed; --cyan:#22d3ee; --gold:#f59e0b; --glass:rgba(255,255,255,.06);}

    header.nav{position:sticky; top:0; z-index:20; backdrop-filter:saturate(140%) blur(10px);
      background:linear-gradient(135deg, rgba(124,58,237,.22), rgba(34,211,238,.12)); border-bottom:1px solid rgba(255,255,255,.06)}
    .container{max-width:72rem; margin-inline:auto; padding-inline:1rem}
    .title-grad{background:linear-gradient(45deg, #a78bfa, #22d3ee, #f59e0b); -webkit-background-clip:text; background-clip:text; color:transparent}
    .card{border:1px solid rgba(255,255,255,.08); background:var(--glass); border-radius:1rem; transition:.18s ease}
    .btn{border-radius:.9rem; padding:.75rem 1rem; font-weight:700; transition:.18s ease; cursor:pointer}
    .btn-primary{background:linear-gradient(135deg, var(--vio), var(--cyan)); color:#fff}
    .btn-ghost{background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); color:#fff}
    .hover-scale:hover{transform:scale(1.03); box-shadow:0 10px 24px rgba(0,0,0,.35)}
    footer{border-top:1px solid rgba(255,255,255,.08); background:rgba(0,0,0,.4)}

    .social{display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:10px;
      background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); transition:.18s ease}
    .social:hover{transform:scale(1.07); box-shadow:0 8px 18px rgba(0,0,0,.35)}

    /* Intro */
    #intro{position:fixed; inset:0; z-index:50; display:flex; align-items:center; justify-content:center; overflow:hidden;
      background:radial-gradient(1200px 800px at 50% 50%, rgba(124,58,237,.14), transparent 60%),
                 linear-gradient(180deg, rgba(11,18,32,.96), rgba(11,18,32,.98));}
    #intro .halo{position:absolute; width:150vmax; height:150vmax; background:
      radial-gradient(closest-side, rgba(124,58,237,.18), transparent 65%),
      radial-gradient(farthest-corner at 20% 80%, rgba(34,211,238,.16), transparent 60%);
      animation:spin 16s linear infinite; opacity:.85}
    #intro .grid{position:absolute; inset:0; background-image:
      linear-gradient(90deg, rgba(255,255,255,.05) 1px, transparent 1px),
      linear-gradient(0deg,  rgba(255,255,255,.05) 1px, transparent 1px);
      background-size:100px 100px; opacity:.12}
    @keyframes spin{to{transform:rotate(360deg)}}
    .intro-content{position:relative; z-index:2; text-align:center}
    .intro-logo{width:min(36vmin, 280px); height:min(36vmin, 280px); border-radius:9999px; overflow:hidden;
      border:3px solid rgba(255,255,255,.2); box-shadow:0 0 0 12px rgba(124,58,237,.12), 0 28px 80px rgba(0,0,0,.55);
      transform:scale(.85); opacity:0; animation:pop .9s cubic-bezier(.2,.9,.2,1) .25s forwards}
    @keyframes pop{to{transform:scale(1); opacity:1;}}
    .intro-top{position:absolute; top:clamp(12px,4vmin,28px); right:clamp(12px,4vmin,28px);
      font-weight:900; font-size:clamp(36px, 8vmin, 80px);
      background:linear-gradient(45deg,#fff,#a7f3d0,#22d3ee); -webkit-background-clip:text; color:transparent;
      transform:translateY(-10px); opacity:0; animation:slideIn .9s ease .35s forwards}
    .intro-bottom{position:absolute; bottom:clamp(12px,4vmin,28px); left:clamp(12px,4vmin,28px);
      font-weight:900; font-size:clamp(36px, 8vmin, 80px);
      background:linear-gradient(45deg,#fff,#fcd34d,#a78bfa); -webkit-background-clip:text; color:transparent;
      transform:translateY(10px); opacity:0; animation:slideIn .9s ease .55s forwards}
    @keyframes slideIn{to{transform:translateY(0); opacity:1;}}
    .intro-skip{position:absolute; top:18px; left:18px; font-size:12px; padding:.45rem .7rem; border-radius:.6rem;
      background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.16); backdrop-filter:blur(6px)}
    .intro-fade{animation:fadeOut .65s ease forwards}
    @keyframes fadeOut{to{opacity:0; visibility:hidden}}
  </style>
</head>
<body>

  <!-- Intro -->
  <div id="intro" aria-hidden="true">
    <div class="halo"></div>
    <div class="grid"></div>
    <button class="intro-skip" id="skipIntro">تخطي</button>
    <div class="intro-top">مستر</div>
    <div class="intro-bottom">بريزنتيشن</div>
    <div class="intro-content">
      <img src="logo.png" alt="Logo" class="intro-logo">
    </div>
  </div>

  <!-- Header -->
  <header class="nav">
    <div class="container py-3 flex items-center gap-3">
      <a href="#" class="flex items-center gap-2 hover-scale">
        <img src="logo.png" alt="Mr Presentation" class="h-9 w-9 rounded-full ring-2 ring-white/10" onerror="this.style.display='none'">
        <span class="font-extrabold text-lg">Mr Presentation</span>
      </a>
      <div class="flex items-center gap-2 ms-auto me-2">
        <a class="social" target="_blank" aria-label="TikTok"
           href="https://www.tiktok.com/@mr_presentation" title="TikTok">
          <svg width="18" height="18" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M41 16.2c-4.8-.6-8.5-3.2-10.3-7.2V33c0 6.7-5.5 12.1-12.3 12.1S6 39.7 6 33s5.5-12.1 12.3-12.1c1 0 2 .1 2.9.3v7A5.4 5.4 0 0 0 18.3 28c-3 0-5.5 2.4-5.5 5.4s2.5 5.4 5.5 5.4S24 36.4 24 33V2h6.7c1.6 5.2 5.7 9 10.9 10.2v4z" fill="currentColor"/>
          </svg>
        </a>
        <a class="social" target="_blank" aria-label="Instagram"
           href="https://www.instagram.com/mr_presentation.1" title="Instagram">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M7 2C4.243 2 2 4.243 2 7v10c0 2.757 2.243 5 5 5h10c2.757 0 5-2.243 5-5V7c0-2.757-2.243-5-5-5H7zm10 2a3 3 0 0 1 3 3v10a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V7a3 3 0 0 1 3-3h10zm-5 3a5 5 0 1 0 0 10 5 5 0 0 0 0-10zm6-1a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
          </svg>
        </a>
      </div>
    </div>
  </header>

  <main>
    <!-- Hero -->
    <section class="relative">
      <div class="container py-14 grid md:grid-cols-2 gap-10 items-center">
        <div>
          <h1 class="text-4xl md:text-5xl font-extrabold leading-tight">
            نسوّي لك <span class="title-grad">عرض بوربوينت يبيض الوجه</span> ويشد الانتباه
          </h1>
          <p class="mt-4 text-gray-200/90 text-lg">قوالب جاهزة + تصميم من الصفر. نخدم الخليج والسعودية ومصر — تصميم احترافي، إنفوجرافيك، وتسليم سريع.</p>
          <div class="mt-6 flex flex-wrap gap-3">
            <a href="#templates" class="btn btn-primary hover-scale">شوف القوالب</a>
            <a href="#maker" class="btn btn-ghost hover-scale">جرّب توليد العرض</a>
          </div>
        </div>

        <div class="card p-3 hover-scale">
          <div class="aspect-[9/16] w-full rounded-xl overflow-hidden bg-black/60">
            <model-viewer src="robot.glb" autoplay animation-name="*" animation-loop auto-rotate auto-rotate-delay="0"
              camera-controls disable-tap exposure="1.1" shadow-intensity="0"
              style="width:100%; height:100%; background:transparent;">
            </model-viewer>
          </div>
          <p class="text-xs text-gray-300 mt-2">لو ما ظهر الروبوت، تأكد من وجود <b>robot.glb</b> جنب index.html.</p>
        </div>
      </div>
    </section>

    <!-- Templates -->
    <section id="templates" class="relative py-14">
      <div class="container">
        <h2 class="text-3xl font-extrabold mb-8">القوالب الجاهزة</h2>
        <div class="grid md:grid-cols-2 gap-6">
          <article class="card p-4 hover-scale">
            <div class="aspect-video rounded-lg overflow-hidden bg-black/60">
              <video class="template-video w-full h-full object-cover" autoplay muted loop playsinline controls data-template="Template 1">
                <source src="template1.mp4" type="video/mp4">
              </video>
            </div>
          </article>
          <article class="card p-4 hover-scale">
            <div class="aspect-video rounded-lg overflow-hidden bg-black/60">
              <video class="template-video w-full h-full object-cover" autoplay muted loop playsinline controls data-template="Template 2">
                <source src="template2.mp4" type="video/mp4">
              </video>
            </div>
          </article>
        </div>
      </div>
    </section>

    <!-- Maker -->
    <section id="maker" class="relative py-14">
      <div class="container">
        <h2 class="text-3xl font-extrabold mb-6">حوّل نصك أو ملفاتك إلى بوربوينت</h2>

        <div class="grid md:grid-cols-2 gap-6">
          <div class="card p-4">
            <label class="block font-semibold mb-2">المصدر:</label>
            <div class="flex flex-wrap gap-3 mb-4 text-sm">
              <label class="inline-flex items-center gap-2"><input type="radio" name="src" value="text" checked> نص يدوي</label>
              <label class="inline-flex items-center gap-2"><input type="radio" name="src" value="file"> ملف (PDF / DOCX / TXT)</label>
            </div>

            <div id="textBoxWrap">
              <label class="block mb-2 font-semibold">النص (عربي أو إنجليزي):</label>
              <textarea id="pptText" class="w-full h-48 rounded-md p-3 text-black" placeholder="اكتب أو الصق النص هنا.
افصل بين الشرائح بـ /// (اختياري)"></textarea>
            </div>

            <div id="fileBoxWrap" class="hidden">
              <label class="block mb-2 font-semibold">ارفع ملفك:</label>
              <input id="fileInput" type="file" accept=".pdf,.docx,.txt" class="w-full rounded-md p-2 bg-white text-black" />
              <p class="text-xs text-gray-300 mt-2">PDF: كل صفحة = شريحة (أو تقسيم ذكي). DOCX/TXT: تقسيم تلقائي أو بفواصل ///.</p>
            </div>

            <div class="grid grid-cols-2 gap-4 mt-4">
              <div>
                <label class="block mb-2 font-semibold">عدد الشرائح (اختياري):</label>
                <input id="slideCount" type="number" min="1" class="w-full rounded-md p-2 text-black" placeholder="سيبها فاضية للتقسيم التلقائي" />
              </div>
              <div>
                <label class="block mb-2 font-semibold">التخصص/الموضوع:</label>
                <select id="topic" class="w-full rounded-md p-2 text-black">
                  <option value="cyber">Cyber</option>
                  <option value="marketing">Marketing</option>
                  <option value="dentist">Dentist</option>
                  <option value="heart">Heart</option>
                  <option value="hospital">Hospital</option>
                  <option value="company_profile">Company profile (بدون صور)</option>
                </select>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mt-4">
              <div>
                <label class="block mb-2 font-semibold">خلفية السلايد (Selectable):</label>
                <select id="bgImage" class="w-full rounded-md p-2 text-black">
                  <option value="">بدون</option>
                  <option value="assets/backgrounds/bg-tech.jpg">bg-tech.jpg</option>
                  <option value="assets/backgrounds/bg-clean.jpg">bg-clean.jpg</option>
                  <option value="assets/backgrounds/bg-gradient.jpg">bg-gradient.jpg</option>
                </select>
              </div>
              <div>
                <label class="block mb-2 font-semibold">لغة النص:</label>
                <select id="lang" class="w-full rounded-md p-2 text-black">
                  <option value="auto">تلقائي</option>
                  <option value="ar">عربي (RTL)</option>
                  <option value="en">English (LTR)</option>
                </select>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mt-4">
              <div>
                <label class="block mb-2 font-semibold">وضع PDF:</label>
                <select id="pdfMode" class="w-full rounded-md p-2 text-black">
                  <option value="pages">كل صفحة = شريحة</option>
                  <option value="smart">تقسيم ذكي</option>
                </select>
              </div>
              <div>
                <label class="block mb-2 font-semibold">صور لكل شريحة:</label>
                <input id="imgsPerSlide" type="number" min="0" max="4" value="2" class="w-full rounded-md p-2 text-black" />
                <label class="inline-flex items-center gap-2 mt-3">
                  <input id="useOnlineImages" type="checkbox"> جلب صور أونلاين (Pixabay)
                </label>
              </div>
            </div>

            <button id="genBtn" class="btn btn-primary hover-scale mt-5 w-full">توليد ملف بوربوينت</button>
            <div id="genStatus" class="text-sm text-gray-200 mt-3"></div>
          </div>

          <div class="card p-4">
            <h3 class="font-bold text-lg mb-2">إرشادات</h3>
            <ul class="list-disc ps-6 text-sm text-gray-200 space-y-1">
              <li>PDF: اختر “كل صفحة = شريحة” أو “تقسيم ذكي”.</li>
              <li>DOCX: هنستخرج النص ونقسم تلقائيًا أو بفواصل <b>///</b>.</li>
              <li>الخلفية تُضاف <b>كصورة داخل السلايد</b> وتقدر تعدلها في PowerPoint.</li>
              <li>لو مش معلّم “أونلاين” هنعتمد على الصور المحلية (لو موجودة).</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- Pricing -->
    <section id="pricing" class="py-14">
      <div class="container">
        <h2 class="text-2xl sm:text-3xl font-extrabold mb-8">الباقات</h2>
        <div class="grid md:grid-cols-3 gap-6">
          <div class="card p-6 hover-scale">
            <h3 class="font-extrabold text-lg mb-2">Basic</h3>
            <p class="text-gray-200 mb-4">حتى 10 شرائح | تصميم أنيق بسيط</p>
            <div class="text-3xl font-extrabold mb-4">SAR <span>150</span></div>
            <div class="text-xs text-gray-300 mb-4">سعر الشريحة: 15 ريال</div>
            <a href="https://wa.me/201141965776?text=أرغب%20بباقة%20Basic" class="btn btn-ghost w-full hover-scale">اطلب الآن</a>
          </div>
          <div class="card p-6 hover-scale" style="border-color: rgba(245,158,11,.6); background: linear-gradient(135deg, rgba(124,58,237,.16), rgba(34,211,238,.12));">
            <div class="inline-flex items-center gap-2 px-2 py-1 rounded-lg bg-yellow-500/20 text-xs mb-3">الأكثر طلبًا</div>
            <h3 class="font-extrabold text-lg mb-2">Premium</h3>
            <p class="text-gray-100 mb-4">حتى 25 شريحة | إنفوجرافيك وانتقالات</p>
            <div class="text-3xl font-extrabold mb-1">SAR <span>375</span></div>
            <div class="text-xs text-gray-200 mb-4">سعر الشريحة: 15 ريال</div>
            <a href="https://wa.me/201141965776?text=أرغب%20بباقة%20Premium" class="btn btn-primary w-full hover-scale">احجز الآن</a>
          </div>
          <div class="card p-6 hover-scale">
            <h3 class="font-extrabold text-lg mb-2">VIP</h3>
            <p class="text-gray-200 mb-4">حتى 50 شريحة | كتابة نصوص + فيديو تصدير</p>
            <div class="text-3xl font-extrabold mb-1">SAR <span>750</span></div>
            <div class="text-xs text-gray-300 mb-4">سعر الشريحة: 15 ريال</div>
            <a href="https://wa.me/201141965776?text=أرغب%20بباقة%20VIP" class="btn btn-ghost w-full hover-scale">تواصل</a>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="py-10">
    <div class="container flex flex-col sm:flex-row items-center justify-between gap-4">
      <p class="text-sm text-gray-300">© <span id="y"></span> Mr Presentation (مستر بريزنتيشن). كل الحقوق محفوظة.</p>
      <div class="flex items-center gap-4 text-sm">
        <a href="https://wa.me/201141965776" class="hover-scale">واتساب</a>
        <a href="tel:01141965776" class="hover-scale">اتصال</a>
      </div>
    </div>
  </footer>

  <!-- Intro close -->
  <script>
    const intro = document.getElementById('intro');
    const skip  = document.getElementById('skipIntro');
    function closeIntro(){ intro.classList.add('intro-fade'); setTimeout(()=>intro.remove(), 650); }
    const seen = sessionStorage.getItem('introSeen');
    if(seen){ closeIntro(); } else { setTimeout(closeIntro, 2800); sessionStorage.setItem('introSeen','1'); }
    skip?.addEventListener('click', closeIntro);
    document.getElementById('y').textContent = new Date().getFullYear();
  </script>

  <!-- منطق التوليد -->
  <script>
    // مفاتيح/إعدادات
    const PIXABAY_KEY = "o3oq2V6UboGDhctKU2pMVNqp1HnuXNim6BYqnC0gtr50WLbJ8BRXAtPt"; // مفتاحك
    const TOPICS_LOCAL = {
      cyber:     { path: 'assets/topics/cyber/',     useImages: true,  count: 20 },
      marketing: { path: 'assets/topics/marketing/', useImages: true,  count: 20 },
      dentist:   { path: 'assets/topics/dentist/',   useImages: true,  count: 20 },
      heart:     { path: 'assets/topics/heart/',     useImages: true,  count: 20 },
      hospital:  { path: 'assets/topics/hospital/',  useImages: true,  count: 20 },
      company_profile: { path: 'assets/topics/company_profile/', useImages: false, count: 0 }
    };

    function topicToQuery(topic){
      switch(topic){
        case 'cyber': return 'cyber security technology network';
        case 'marketing': return 'digital marketing business strategy';
        case 'dentist': return 'dentist dental clinic teeth care';
        case 'heart': return 'cardiology heart health medical';
        case 'hospital': return 'hospital healthcare doctor clinic';
        case 'company_profile': return '';
        default: return 'business presentation abstract';
      }
    }

    function urlToDataURL(u){
      return fetch(u)
        .then(r=>r.blob())
        .then(b=>new Promise(res=>{const fr=new FileReader(); fr.onloadend=()=>res(fr.result); fr.readAsDataURL(b);}))
        .catch(()=>null);
    }

    function fetchLocalImages(topicKey, n){
      const t = TOPICS_LOCAL[topicKey];
      if (!t || !t.useImages) return [];
      const out = [];
      const max = Math.max(1, t.count||0);
      for (let i=0; i<Math.min(n,4); i++){
        const idx = 1 + Math.floor(Math.random()*max);
        out.push(`${t.path}${idx}.jpg`);
      }
      return out;
    }

    async function fetchPixabayImages(topicKey, count=2){
      if (!PIXABAY_KEY) return [];
      const q = topicToQuery(topicKey);
      if (!q) return [];
      const per = Math.min(count||2, 4);
      const url = `https://pixabay.com/api/?key=${PIXABAY_KEY}&q=${encodeURIComponent(q)}&image_type=photo&orientation=horizontal&per_page=${per}&safesearch=true`;
      try{
        const r = await fetch(url);
        const j = await r.json();
        const hits = Array.isArray(j.hits) ? j.hits : [];
        return hits.slice(0, per).map(h => h.webformatURL).filter(Boolean);
      }catch{
        return [];
      }
    }

    async function addImagesToSlide(slide, topicKey, imgsPerSlide, useOnline){
      if (topicKey==='company_profile' || !imgsPerSlide) return;
      const slots = [
        { x:0.5, y:4.55, w:4.5, h:3.0 },
        { x:5.1, y:4.55, w:4.5, h:3.0 },
        { x:0.5, y:1.0,  w:3.4, h:2.2 },
        { x:6.1, y:1.0,  w:3.4, h:2.2 },
      ];
      let urls = useOnline ? await fetchPixabayImages(topicKey, imgsPerSlide)
                           : fetchLocalImages(topicKey, imgsPerSlide);
      urls = urls.slice(0, Math.min(imgsPerSlide, 4));
      const datas = await Promise.all(urls.map(u => urlToDataURL(u)));
      datas.forEach((data,i)=>{ if(data) slide.addImage({ data, ...slots[i] }); });
    }

    function splitTextIntoSlides(text, desiredCount) {
      if (text.includes('///')) return text.split('///').map(s => s.trim()).filter(Boolean);
      const paragraphs = text.split(/\n{2,}/).map(p => p.trim()).filter(Boolean);
      if (!desiredCount || desiredCount < 1) {
        const chunks = []; let buf = [];
        paragraphs.forEach((p, i) => { buf.push(p); if (buf.length >= 2 || i === paragraphs.length - 1) { chunks.push(buf.join('\\n\\n')); buf = []; } });
        return chunks.length ? chunks : [text];
      } else {
        const per = Math.ceil(paragraphs.length / desiredCount);
        const slides = [];
        for (let i = 0; i < desiredCount; i++) {
          const start = i * per;
          const slice = paragraphs.slice(start, start + per);
          if (slice.length) slides.push(slice.join('\\n\\n'));
        }
        return slides.length ? slides : [text];
      }
    }

    async function readTxt(file){ return await file.text(); }

    async function readDocx(file){
      const arrayBuffer = await file.arrayBuffer();
      const res = await mammoth.extractRawText({ arrayBuffer });
      return (res && res.value) ? res.value : '';
    }

    async function readPdf(file, mode='pages'){
      const buf = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
      const pages = [];
      for (let p=1; p<=pdf.numPages; p++){
        const page = await pdf.getPage(p);
        const content = await page.getTextContent();
        const strings = content.items.map(i => i.str).filter(Boolean);
        const text = strings.join(' ').replace(/\s+/g,' ').trim();
        pages.push(text);
      }
      if (mode === 'pages') return pages;
      const merged = [];
      let acc = '';
      pages.forEach((t,i)=>{
        if ((acc + ' ' + t).length < 800) acc = (acc? (acc+' '+t): t);
        else { merged.push(acc); acc = t; }
        if (i===pages.length-1 && acc) merged.push(acc);
      });
      return merged;
    }

    function addSelectableBackground(slide, bgPath){
      if (!bgPath) return;
      slide.addImage({ path:bgPath, x:0, y:0, w:10, h:5.625 }); // 16:9
    }

    const srcRadios   = document.getElementsByName('src');
    const textBoxWrap = document.getElementById('textBoxWrap');
    const fileBoxWrap = document.getElementById('fileBoxWrap');
    srcRadios.forEach(r => r.addEventListener('change', () => {
      const isText = document.querySelector('input[name="src"]:checked').value === 'text';
      textBoxWrap.classList.toggle('hidden', !isText);
      fileBoxWrap.classList.toggle('hidden', isText);
    }));

    const status = document.getElementById('genStatus');
    document.getElementById('genBtn')?.addEventListener('click', async () => {
      const srcType = document.querySelector('input[name="src"]:checked').value;
      const txtEl = document.getElementById('pptText');
      const fileEl = document.getElementById('fileInput');

      const topic = document.getElementById('topic').value;
      const bgImg = document.getElementById('bgImage').value;
      const langSel = document.getElementById('lang').value;
      const pdfMode = document.getElementById('pdfMode').value;
      const imgsPerSlide = parseInt(document.getElementById('imgsPerSlide').value, 10) || 0;
      const useOnline = document.getElementById('useOnlineImages').checked;

      const count = parseInt(document.getElementById('slideCount').value, 10);
      status.textContent = 'جاري التحضير...';

      if (typeof PptxGenJS === 'undefined'){
        status.textContent = 'تعذّر تحميل مكتبة البوربوينت (تأكد من libs/pptxgen.bundle.js).';
        return;
      }

      let slidesText = [];
      try{
        if (srcType === 'text'){
          const raw = (txtEl.value || '').trim();
          if (!raw){ status.textContent = 'اكتب النص أولاً.'; return; }
          slidesText = splitTextIntoSlides(raw, isNaN(count) ? undefined : count);
        } else {
          const file = fileEl.files?.[0];
          if (!file){ status.textContent = 'اختَر ملف أولاً.'; return; }
          const ext = file.name.toLowerCase().split('.').pop();
          if (ext === 'pdf'){
            const arr = await readPdf(file, pdfMode);
            slidesText = isNaN(count) ? arr : splitTextIntoSlides(arr.join('\n\n'), count);
          } else if (ext === 'docx'){
            const text = await readDocx(file);
            slidesText = splitTextIntoSlides(text, isNaN(count) ? undefined : count);
          } else if (ext === 'txt'){
            const text = await readTxt(file);
            slidesText = splitTextIntoSlides(text, isNaN(count) ? undefined : count);
          } else {
            status.textContent = 'صيغة غير مدعومة. ارفع PDF أو DOCX أو TXT.';
            return;
          }
        }
      }catch(e){
        console.error(e);
        status.textContent = 'حصل خطأ أثناء قراءة الملف. جرّب ملف أبسط أو صيغة مختلفة.';
        return;
      }

      if (!slidesText.length){ status.textContent = 'مافيش محتوى كفاية لعمل شرائح.'; return; }

      status.textContent = 'جاري إنشاء العرض...';
      const pptx = new PptxGenJS();
      pptx.layout = 'LAYOUT_16x9';
      const rtl = (langSel === 'ar') || (langSel === 'auto' && /[\u0600-\u06FF]/.test(slidesText.join(' ')));
      pptx.rtlMode = rtl;

      // غلاف
      let cover = pptx.addSlide();
      addSelectableBackground(cover, bgImg);
      cover.addText('Mr Presentation | مستر بريزنتيشن', { x:0.5, y:0.7, w:9.0, h:0.8, fontSize:28, bold:true, color:'FFFFFF', align:rtl?'right':'left' });
      cover.addText('تم إنشاء العرض تلقائيًا من نص/ملف العميل', { x:0.5, y:1.5, w:9.0, h:0.6, fontSize:16, color:'DADADA', align:rtl?'right':'left' });

      // الشرائح
      for (let i=0; i<slidesText.length; i++){
        const s = pptx.addSlide();
        addSelectableBackground(s, bgImg);
        s.addText(`الشريحة ${i+1}`, { x:0.5, y:0.5, w:9.0, fontSize:22, bold:true, color:'FFFFFF', align:rtl?'right':'left' });
        s.addText(slidesText[i], { x:0.7, y:1.3, w:8.6, h:2.9, fontSize:16, color:'FFFFFF', align:rtl?'right':'left', bullet:true });
        await addImagesToSlide(s, topic, imgsPerSlide, useOnline);
      }

      // ختامية
      let end = pptx.addSlide();
      addSelectableBackground(end, bgImg);
      end.addText('تم — شكراً لكم', { x:0.5, y:3.5, w:9.0, h:1.0, fontSize:26, bold:true, color:'FFFFFF', align:'center' });

      status.textContent = 'جاري التحميل...';
      try{
        await pptx.writeFile({ fileName: `MrPresentation_${topic}_${Date.now()}.pptx` });
        status.textContent = 'تم إنشاء الملف وتحميله ✅';
      }catch(e){
        status.textContent = 'خطأ أثناء الحفظ. قلّل حجم النص أو الصور.';
      }
    });
  </script>
</body>
</html>
